# Flujo OAuth2 Authorization Code - Diagrama

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             â”‚           â”‚             â”‚           â”‚             â”‚
â”‚   Browser   â”‚           â”‚   Backend   â”‚           â”‚  Keycloak   â”‚
â”‚  (Next.js)  â”‚           â”‚  (Express)  â”‚           â”‚             â”‚
â”‚             â”‚           â”‚             â”‚           â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                         â”‚                         â”‚
       â”‚  1. Click "Login"       â”‚                         â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>                         â”‚
       â”‚                         â”‚                         â”‚
       â”‚  2. Redirect to /auth/login                       â”‚
       â”‚                         â”‚                         â”‚
       â”‚  3. Redirect to Keycloak Auth URL                 â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                         â”‚
       â”‚                         â”‚                         â”‚
       â”‚  4. Redirect to Keycloak                          â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                         â”‚                         â”‚
       â”‚  5. User enters credentials (DIRECTLY IN KEYCLOAK)â”‚
       â”‚                         â”‚                         â”‚
       â”‚  6. Authorization Code  â”‚                         â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚    (redirect to backend/auth/callback?code=XXX)   â”‚
       â”‚                         â”‚                         â”‚
       â”‚                         â”‚  7. Exchange code for tokens
       â”‚                         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                         â”‚                         â”‚
       â”‚                         â”‚  8. access_token +      â”‚
       â”‚                         â”‚     refresh_token +     â”‚
       â”‚                         â”‚     id_token            â”‚
       â”‚                         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                         â”‚                         â”‚
       â”‚  9. Set httpOnly cookie â”‚                         â”‚
       â”‚     (refresh_token)     â”‚                         â”‚
       â”‚  10. Redirect to frontend                         â”‚
       â”‚      with access_token  â”‚                         â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                         â”‚
       â”‚                         â”‚                         â”‚
       â”‚  11. Save access_token  â”‚                         â”‚
       â”‚      in sessionStorage  â”‚                         â”‚
       â”‚                         â”‚                         â”‚
       â•žâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¡                         â”‚
       â”‚  USING THE APP          â”‚                         â”‚
       â•žâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¡                         â”‚
       â”‚                         â”‚                         â”‚
       â”‚  12. API call with      â”‚                         â”‚
       â”‚      Bearer token       â”‚                         â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>                         â”‚
       â”‚                         â”‚                         â”‚
       â”‚                         â”‚  13. Verify token       â”‚
       â”‚                         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                         â”‚                         â”‚
       â”‚                         â”‚  14. Token info         â”‚
       â”‚                         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                         â”‚                         â”‚
       â”‚  15. Protected data     â”‚                         â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                         â”‚
       â”‚                         â”‚                         â”‚
       â•žâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¡                         â”‚
       â”‚  TOKEN REFRESH          â”‚                         â”‚
       â•žâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¡                         â”‚
       â”‚                         â”‚                         â”‚
       â”‚  16. Token expired      â”‚                         â”‚
       â”‚      POST /auth/refresh â”‚                         â”‚
       â”‚      (cookie included)  â”‚                         â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>                         â”‚
       â”‚                         â”‚                         â”‚
       â”‚                         â”‚  17. Refresh token      â”‚
       â”‚                         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                         â”‚                         â”‚
       â”‚                         â”‚  18. New access_token   â”‚
       â”‚                         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                         â”‚                         â”‚
       â”‚  19. New access_token   â”‚                         â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                         â”‚
       â”‚                         â”‚                         â”‚
       â•žâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¡                         â”‚
       â”‚  LOGOUT                 â”‚                         â”‚
       â•žâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¡                         â”‚
       â”‚                         â”‚                         â”‚
       â”‚  20. POST /auth/logout  â”‚                         â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>                         â”‚
       â”‚                         â”‚                         â”‚
       â”‚                         â”‚  21. Revoke tokens      â”‚
       â”‚                         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                         â”‚                         â”‚
       â”‚  22. Clear cookies      â”‚                         â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                         â”‚
       â”‚                         â”‚                         â”‚
       â”‚  23. Redirect to home   â”‚                         â”‚
       â”‚                         â”‚                         â”‚
```

## ðŸ”‘ Seguridad en cada paso:

1-6: **Usuario autentica en Keycloak**, no en tu app
7: **Backend usa client_secret** (frontend nunca lo ve)
8: **Tokens solo los ve el backend**
9: **refresh_token en httpOnly cookie** (JS no puede acceder)
10: **access_token en URL** (temporal, se guarda en memoria)
11: **sessionStorage** (se pierde al cerrar tab)
12-15: **Bearer token en cada request**
16-19: **Refresh automÃ¡tico** sin re-login
20-22: **Logout limpia todo**

## ðŸ“ Tokens almacenados:

### Backend (httpOnly cookies):
- `refresh_token` - VÃ¡lido 30 dÃ­as
- `id_token` - Para logout

### Frontend (sessionStorage):
- `access_token` - VÃ¡lido 5 minutos, se pierde al cerrar tab

### Â¿Por quÃ© es seguro?
- âœ… XSS no puede robar refresh_token (httpOnly)
- âœ… Cerrar tab = pierde access_token
- âœ… Client secret nunca sale del backend
- âœ… Credenciales solo en Keycloak
